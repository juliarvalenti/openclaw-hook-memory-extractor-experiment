# Multi-agent OpenClaw setup for PoC #6 (channel-native agent coordination)
#
# Each agent runs its own gateway container — mirroring the distributed
# deployment target where each agent lives on a separate host.
#
# All agents connect to a shared Synapse Matrix homeserver on the `agents`
# Docker network. The Matrix room (#agents:local) is the coordination medium.
#
# Usage:
#   ./setup.sh                            # one-time: generate config + register users
#   docker compose up                     # start Matrix + all three agents
#   docker compose up matrix agent-a      # start Matrix + one agent
#   docker compose logs -f agent-a        # tail one agent
#   docker compose down                   # stop everything
#
# Prerequisites:
#   1. Build the OpenClaw image (from openclaw repo root):
#        docker build -t openclaw:local .
#   2. Copy .env.example → .env and fill in values
#   3. Run ./setup.sh to initialize Synapse and register agent users

services:

  # ── Matrix homeserver ────────────────────────────────────────────────────────
  # Synapse: reference Matrix homeserver implementation.
  # Data is persisted in ./synapse/data (created by setup.sh).
  #
  # No port exposed to host by default; add "8008:8008" under ports: if you
  # want to connect with a Matrix client (Element) for debugging.
  matrix:
    image: matrixdotorg/synapse:latest
    volumes:
      - ./synapse/data:/data
    ports:
      - "8008:8008"
    networks:
      - agents
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8008/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 24
      start_period: 15s

  # ── Agent A ─────────────────────────────────────────────────────────────────
  agent-a:
    build: .
    image: ${OPENCLAW_IMAGE:-openclaw-agents:local}
    environment:
      HOME: /home/node
      # LLM provider key — set in .env. Swap for OPENAI_API_KEY etc. if desired.
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      # Gateway auth token — used to connect to this agent's gateway via WS.
      OPENCLAW_GATEWAY_TOKEN: ${AGENT_A_TOKEN:?AGENT_A_TOKEN is required}
      # Matrix connection (resolved at runtime by the matrix channel plugin).
      MATRIX_HOMESERVER: http://matrix:8008
      MATRIX_USER_ID: "@agent-a:local"
      MATRIX_PASSWORD: ${AGENT_A_MATRIX_PASSWORD:?AGENT_A_MATRIX_PASSWORD is required}
    volumes:
      - ./configs/agent-a:/home/node/.openclaw
    ports:
      - "${AGENT_A_PORT:-18789}:18789"
    networks:
      - agents
    depends_on:
      matrix:
        condition: service_healthy
    command: ["node", "dist/index.js", "gateway", "--bind", "lan"]
    restart: unless-stopped

  # ── Agent B ─────────────────────────────────────────────────────────────────
  agent-b:
    build: .
    image: ${OPENCLAW_IMAGE:-openclaw-agents:local}
    environment:
      HOME: /home/node
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENCLAW_GATEWAY_TOKEN: ${AGENT_B_TOKEN:?AGENT_B_TOKEN is required}
      MATRIX_HOMESERVER: http://matrix:8008
      MATRIX_USER_ID: "@agent-b:local"
      MATRIX_PASSWORD: ${AGENT_B_MATRIX_PASSWORD:?AGENT_B_MATRIX_PASSWORD is required}
    volumes:
      - ./configs/agent-b:/home/node/.openclaw
    ports:
      - "${AGENT_B_PORT:-18889}:18789"
    networks:
      - agents
    depends_on:
      matrix:
        condition: service_healthy
    command: ["node", "dist/index.js", "gateway", "--bind", "lan"]
    restart: unless-stopped

  # ── Agent C ─────────────────────────────────────────────────────────────────
  agent-c:
    build: .
    image: ${OPENCLAW_IMAGE:-openclaw-agents:local}
    environment:
      HOME: /home/node
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENCLAW_GATEWAY_TOKEN: ${AGENT_C_TOKEN:?AGENT_C_TOKEN is required}
      MATRIX_HOMESERVER: http://matrix:8008
      MATRIX_USER_ID: "@agent-c:local"
      MATRIX_PASSWORD: ${AGENT_C_MATRIX_PASSWORD:?AGENT_C_MATRIX_PASSWORD is required}
    volumes:
      - ./configs/agent-c:/home/node/.openclaw
    ports:
      - "${AGENT_C_PORT:-18989}:18789"
    networks:
      - agents
    depends_on:
      matrix:
        condition: service_healthy
    command: ["node", "dist/index.js", "gateway", "--bind", "lan"]
    restart: unless-stopped

networks:
  agents:
    driver: bridge
